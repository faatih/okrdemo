# Story 1.3: Authentication (Email/Password)

## Status
Draft

## Story
**As a** user,
**I want** to log in with my email and password,
**so that** I can access my organization's OKRs securely.

## Acceptance Criteria
1. NextAuth.js configured with email/password provider (credentials)
2. Login page (`/login`) with email and password inputs, "Sign In" button, basic validation
3. Password hashing implemented using bcrypt or Argon2 (NFR9)
4. Session management via NextAuth with secure HTTP-only cookies
5. Protected routes redirect to `/login` if user not authenticated (middleware check)
6. Logout functionality accessible via user menu in header
7. User creation endpoint (`POST /api/auth/signup`) for initial user registration (manual, no self-service signup for MVP)
8. Login successful redirects to `/dashboard` (placeholder page)
9. CSRF protection enabled via NextAuth built-ins (NFR8)

## Tasks / Subtasks

- [ ] **Understand Better Auth integration from starter pack** (AC: 1, 3, 4, 9)
  - [ ] ✅ Review existing Better Auth 1.2.8 setup (ALREADY CONFIGURED)
  - [ ] ✅ Confirm password hashing is built-in (Better Auth uses secure hashing)
  - [ ] ✅ Confirm session management with HTTP-only cookies (Better Auth default)
  - [ ] ✅ Confirm CSRF protection is enabled (Better Auth built-in)
  - [ ] Document that PRD mentions "NextAuth" but starter uses "Better Auth" (functionally equivalent, modern alternative)

- [ ] **Replace Google OAuth login with email/password login** (AC: 2)
  - [ ] Update `lib/auth.ts` to add email/password credentials provider
  - [ ] Remove or comment out Google OAuth configuration (not in RunwayOKR MVP scope)
  - [ ] Remove Polar.sh plugin from Better Auth config (subscriptions not in scope)
  - [ ] Update auth adapter to only include core tables (user, session, account, verification)

- [ ] **Create email/password login page** (AC: 2, 8)
  - [ ] Rename `/sign-in` to `/login` (update route and all references)
  - [ ] Replace `app/sign-in/page.tsx` (or create `app/login/page.tsx`) with email/password form
  - [ ] Add email input field with validation (required, email format)
  - [ ] Add password input field with validation (required, min 8 characters)
  - [ ] Add "Sign In" button that calls Better Auth credentials sign-in
  - [ ] Implement client-side form validation with error messages
  - [ ] On successful login, redirect to `/dashboard`
  - [ ] Display error message if login fails (invalid credentials)
  - [ ] Update page title: "RunwayOKR - Sign In"

- [ ] **Update middleware for protected routes** (AC: 5)
  - [ ] Review existing `middleware.ts` (already protects /dashboard)
  - [ ] Update redirect paths: `/sign-in` → `/login`
  - [ ] Verify unauthenticated users are redirected to `/login`
  - [ ] Verify authenticated users accessing `/login` are redirected to `/dashboard`
  - [ ] Add `/okrs`, `/check-ins`, `/reviews`, `/imports` to protected routes (for future stories)

- [ ] **Create manual user signup endpoint** (AC: 7)
  - [ ] Create API route: `app/api/auth/signup/route.ts`
  - [ ] Implement POST handler accepting: email, password, name
  - [ ] Validate input with Zod schema (email format, password strength, name required)
  - [ ] Hash password using Better Auth built-in (or bcrypt if manual implementation needed)
  - [ ] Create Better Auth `user` record
  - [ ] Create corresponding `okrUser` record (link to a default team for now, or require teamId)
  - [ ] Return success response with user ID (do NOT auto-login, admin will provide credentials)
  - [ ] Handle errors: duplicate email, validation failures
  - [ ] NOTE: No self-service signup UI for MVP (admin uses this endpoint directly or via admin panel)

- [ ] **Link Better Auth user to okrUser** (AC: 7)
  - [ ] Decide linking strategy: email match or separate auth_user_id column on okrUser
  - [ ] Option A: Match by email (Better Auth `user.email` = `okrUser.email`)
  - [ ] Option B: Add `authUserId` column to `okrUser` table (cleaner, recommended)
  - [ ] If Option B: Update schema in Story 1.2 to add `authUserId` text column (nullable, FK to Better Auth user.id)
  - [ ] Document linking strategy in Dev Notes for future stories

- [ ] **Implement logout functionality** (AC: 6)
  - [ ] Verify Better Auth logout is available via `authClient.signOut()`
  - [ ] Update dashboard header/navbar to include logout button or user menu
  - [ ] On logout click, call Better Auth sign-out endpoint
  - [ ] Redirect to `/login` after successful logout
  - [ ] Clear session cookies (Better Auth handles this automatically)

- [ ] **Remove starter pack Google OAuth pages and components** (AC: 1, 2)
  - [ ] Remove Google OAuth button from login page
  - [ ] Remove `/sign-up` page (no self-service signup in MVP)
  - [ ] Update middleware to remove `/sign-up` from matcher
  - [ ] Remove Terms of Service and Privacy Policy links from login page (or update to RunwayOKR versions)

- [ ] **Test authentication flow end-to-end** (AC: 2, 5, 6, 8)
  - [ ] Manual test: Create user via signup endpoint (curl or Postman)
  - [ ] Manual test: Login with created credentials on `/login` page
  - [ ] Verify redirect to `/dashboard` after successful login
  - [ ] Verify session persists on page refresh (Better Auth session cookie)
  - [ ] Manual test: Access `/dashboard` without login, verify redirect to `/login`
  - [ ] Manual test: Logout from dashboard, verify redirect to `/login`
  - [ ] Manual test: Try to access `/login` while authenticated, verify redirect to `/dashboard`

- [ ] **Update documentation and environment variables** (AC: 1)
  - [ ] Remove Google OAuth env vars from `.env.example` (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)
  - [ ] Remove Polar.sh env vars from `.env.example` (POLAR_ACCESS_TOKEN, POLAR_WEBHOOK_SECRET, etc.)
  - [ ] Add any new env vars if needed (likely none for email/password auth)
  - [ ] Update README.md to document email/password authentication (replace Google OAuth mention)

## Dev Notes

### Previous Story Insights
Story 1.2 created database schema including Better Auth tables (user, session, account, verification) and RunwayOKR business tables (okrUser, team, objective, keyResult, etc.). Authentication will use Better Auth `user` table, while business logic uses `okrUser` table.

### Starter Pack Context
**Better Auth Already Configured:**
The starter pack includes Better Auth 1.2.8 with:
- ✅ Database adapter configured (Drizzle + Neon PostgreSQL)
- ✅ Session management with HTTP-only cookies
- ✅ CSRF protection built-in
- ✅ Password hashing built-in (secure by default)
- ✅ Middleware protecting `/dashboard` routes
- ✅ Sign-in page at `/sign-in` with Google OAuth
- ✅ API route handler at `/api/auth/[...all]`

**What needs to be done:**
1. Replace Google OAuth with email/password credentials provider
2. Remove Polar.sh subscription plugin (not in RunwayOKR scope)
3. Rename `/sign-in` to `/login` (align with PRD)
4. Create manual signup endpoint (no self-service UI)
5. Link Better Auth `user` to RunwayOKR `okrUser` table
6. Remove `/sign-up` page and Google OAuth UI

**Files to Modify:**
- `lib/auth.ts`: Add credentials provider, remove Google OAuth and Polar plugin
- `app/sign-in/page.tsx` → `app/login/page.tsx`: Replace with email/password form
- `middleware.ts`: Update redirect paths from `/sign-in` to `/login`
- `lib/auth-client.ts`: Remove Polar client plugin

**Files to Remove:**
- `app/sign-up/page.tsx`: No self-service signup in MVP
- Google OAuth configuration in `lib/auth.ts`

### PRD vs. Starter Pack Discrepancy
**PRD specifies:** NextAuth.js with email/password provider
**Starter pack uses:** Better Auth 1.2.8 with Google OAuth

**Decision:** Keep Better Auth (modern, well-maintained alternative to NextAuth) and adapt it for email/password. Better Auth provides all PRD requirements:
- ✅ Email/password credentials (supported via credentials provider)
- ✅ Password hashing (bcrypt/Argon2 built-in)
- ✅ Session management with HTTP-only cookies
- ✅ CSRF protection
- ✅ Middleware for protected routes

[Source: architecture/tech-stack.md#Technology Stack Table - Better Auth 1.2.8]

### Better Auth Email/Password Configuration
[Based on Better Auth documentation and starter pack setup]

**Update `lib/auth.ts` to add credentials provider:**

```typescript
import { db } from "@/db/drizzle";
import { account, session, user, verification } from "@/db/schema";
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { nextCookies } from "better-auth/next-js";

export const auth = betterAuth({
  trustedOrigins: [`${process.env.NEXT_PUBLIC_APP_URL}`],
  allowedDevOrigins: [`${process.env.NEXT_PUBLIC_APP_URL}`],
  cookieCache: {
    enabled: true,
    maxAge: 5 * 60, // Cache duration in seconds
  },
  database: drizzleAdapter(db, {
    provider: "pg",
    schema: {
      user,
      session,
      account,
      verification,
    },
  }),
  // Add email/password authentication
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: false, // MVP: skip email verification
  },
  plugins: [
    nextCookies(),
  ],
});
```

**Remove:** Google OAuth (`socialProviders`), Polar plugin, subscription table from adapter

### Login Page Implementation
[Source: architecture/frontend-architecture.md, architecture/coding-standards.md]

**Create `app/login/page.tsx` with email/password form:**

```typescript
"use client";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { authClient } from "@/lib/auth-client";
import { useState } from "react";
import { toast } from "sonner";
import { useRouter } from "next/navigation";

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      await authClient.signIn.email({
        email,
        password,
        callbackURL: "/dashboard",
      });
      router.push("/dashboard");
    } catch (error) {
      console.error("Login failed:", error);
      toast.error("Invalid email or password");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>Sign In to RunwayOKR</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </div>
            <div>
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                minLength={8}
              />
            </div>
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? "Signing in..." : "Sign In"}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Manual User Signup Endpoint
[Source: architecture/backend-architecture.md#Service Architecture, architecture/coding-standards.md]

**Create `app/api/auth/signup/route.ts`:**

```typescript
import { db } from "@/db/drizzle";
import { user as authUser } from "@/db/schema"; // Better Auth user table
import { okrUser, team } from "@/db/schema"; // RunwayOKR business tables
import { auth } from "@/lib/auth";
import { z } from "zod";

const signupSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  name: z.string().min(1),
  teamId: z.string().uuid().optional(), // Optional for now
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { email, password, name, teamId } = signupSchema.parse(body);

    // Check if user already exists
    const existingUser = await db.select().from(authUser).where(eq(authUser.email, email)).limit(1);
    if (existingUser.length > 0) {
      return Response.json({ error: "User already exists" }, { status: 400 });
    }

    // Create Better Auth user (password will be hashed automatically)
    const newAuthUser = await auth.api.signUpEmail({
      email,
      password,
      name,
    });

    // Create corresponding okrUser
    const defaultTeam = await db.select().from(team).limit(1); // Get first team as default
    const newOkrUser = await db.insert(okrUser).values({
      email,
      name,
      teamId: teamId || defaultTeam[0]?.id,
      active: true,
    }).returning();

    return Response.json({
      success: true,
      userId: newAuthUser.id,
      okrUserId: newOkrUser[0].id,
    }, { status: 201 });

  } catch (error) {
    console.error("Signup error:", error);
    if (error instanceof z.ZodError) {
      return Response.json({ error: "Invalid input", details: error.errors }, { status: 400 });
    }
    return Response.json({ error: "Internal server error" }, { status: 500 });
  }
}
```

### Linking Better Auth User to okrUser
[Source: architecture/data-models.md#Model: User]

**Strategy:** Match by email for MVP (both tables store email)

**Lookup logic in API routes:**
```typescript
// Get authenticated user from Better Auth session
const session = await auth.api.getSession({ headers: request.headers });
const authUser = session?.user;

// Find corresponding okrUser by email
const okrUser = await db.select().from(okrUser).where(eq(okrUser.email, authUser.email)).limit(1);
```

**Alternative (Phase 2):** Add `authUserId` column to `okrUser` table for direct FK relationship. For MVP, email matching is sufficient.

### Protected Routes Configuration
[Source: existing middleware.ts, architecture/coding-standards.md]

**Update `middleware.ts` matcher to include all protected pages:**

```typescript
export const config = {
  matcher: [
    "/dashboard/:path*",
    "/okrs/:path*",
    "/check-ins/:path*",
    "/reviews/:path*",
    "/imports/:path*",
    "/settings/:path*",
    "/login",
  ],
};
```

Update redirect logic: `/sign-in` → `/login`

### Security Considerations
[Source: PRD NFR8, NFR9]

**NFR8: CSRF Protection**
- ✅ Better Auth includes CSRF protection by default (no additional config needed)

**NFR9: Password Hashing**
- ✅ Better Auth uses bcrypt or Argon2 internally (secure by default)
- No manual password hashing required

**Session Security:**
- ✅ HTTP-only cookies (Better Auth default)
- ✅ Secure flag in production (Better Auth auto-detects HTTPS)
- ✅ SameSite: Lax (Better Auth default)

### Testing
[Source: architecture/testing-strategy.md#Testing Pyramid]

**For This Story:**
- Manual testing via browser and API client (Postman/curl)
- Test user creation: `POST /api/auth/signup` with valid credentials
- Test login flow: Email/password → redirect to /dashboard
- Test protected routes: Access /dashboard without auth → redirect to /login
- Test logout: Sign out → redirect to /login, session cleared
- Test session persistence: Refresh page while logged in, verify still authenticated

**Future Testing:**
- Integration tests for auth endpoints (Story 2.x+)
- E2E tests for login flow (Phase 2)

### Data Models Reference
[Source: architecture/data-models.md#Model: User]

**Better Auth `user` table (authentication):**
- `id`: text (UUID-like string)
- `email`: text (unique)
- `name`: text
- `emailVerified`: boolean (skip for MVP)
- `password`: text (hashed by Better Auth)
- `image`: text (nullable)
- `createdAt`: timestamp
- `updatedAt`: timestamp

**RunwayOKR `okrUser` table (business logic):**
- `id`: uuid
- `email`: varchar(255) (unique, matches Better Auth user email)
- `name`: varchar(120)
- `teamId`: uuid (FK to team)
- `organizationId`: uuid (nullable, Phase 2)
- `active`: boolean
- `createdAt`: timestamp
- `updatedAt`: timestamp

**Relationship:** Match by email (both tables store email). In API routes, look up okrUser by session user's email.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation adapting PRD NextAuth to Better Auth email/password | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent during implementation_

### Debug Log References
_To be populated by Dev Agent during implementation_

### Completion Notes List
_To be populated by Dev Agent during implementation_

### File List
_To be populated by Dev Agent during implementation_

## QA Results
_To be populated by QA Agent after story completion_
